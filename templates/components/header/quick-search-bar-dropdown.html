<div class="search-bar-dropdown">
  <div class="main-seacrh-bar">
    <form class="search-form" action="{{urls.search}}" data-quick-search-form>
      <input
        type="search"
        name=""
        id="unique-search"
        class="search-bar-input-dropdown"
        name="search_query"
        data-search-quick
        data-error-message="{{lang 'search.error.empty_field'}}"
        placeholder="{{lang 'search.quick_search.input_placeholder'}}"
        autocomplete="off"
      />
    </form>
  </div>
</div>

<style>
  input#unique-search {
    width: 250px;
    padding: 10px;
    border-radius: 26px;
  }

  .search-bar-dropdown {
    display: none;
    position: absolute;
    top: 40px;
    right: 0;
    z-index: 2;
  }

  .search-bar-input-dropdown::placeholder {
    flex: 1;
    flex: 1 1 auto;
    min-width: 0;
    border: none;
    background: transparent;
    height: 48px;
    font-size: 14px;
    font-weight: 300;
    line-height: 150%;
    letter-spacing: -0.28px;
    white-space: nowrap;
    overflow: hidden;

    color: rgba(10, 10, 30, 0.9);
    font-family: "Noto Sans";
    font-size: 14px;
    font-style: normal;
    font-weight: 300;
    line-height: 150%; /* 21px */
    letter-spacing: -0.28px;
  }

  input#unique-search {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    border-radius: 9999px;
    background: #eaeaf0;
    padding: 15px 0px 15px 14px;
    border: 1px solid #ccc;
  }

  /* @media (min-width: 992px) and (max-width : 1250px) {
        .search-bar-dropdown {
            display: block;
        }
    } */
</style>
<!-- NEW SCRIPT  -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchButton = document.querySelector(".navUser .search-button");
    const searchBarDropdown = document.querySelector(".search-bar-dropdown");
    const uniqueSearch1 = document.getElementById("unique-search");

    // Make dropdown focusable
    if (searchBarDropdown) searchBarDropdown.setAttribute("tabindex", "-1");

    const isWithin = (root, target) => {
      return !!(root && target && root.contains(target));
    };

    const openDropdown = () => {
      if (!searchBarDropdown) return;
      searchBarDropdown.style.display = "block";
      searchBarDropdown.focus();
      if (uniqueSearch1) {
        setTimeout(() => uniqueSearch1.focus(), 0);
      }
    };

    const closeDropdown = () => {
      if (!searchBarDropdown) return;
      searchBarDropdown.style.display = "none";
      searchBarDropdown.blur();
      if (uniqueSearch1) uniqueSearch1.blur();
    };

    function handleSearchBar(mediaQuery) {
      if (mediaQuery.matches) {
        if (searchButton) searchButton.style.display = "block";
        if (searchBarDropdown) searchBarDropdown.style.display = "none";

        searchButton.onclick = (e) => {
          e.stopPropagation();
          const isOpen =
            searchBarDropdown && searchBarDropdown.style.display === "block";
          if (isOpen) {
            closeDropdown();
          } else {
            openDropdown();
          }
        };
      } else {
        // Reset styles outside this breakpoint if needed
        if (searchBarDropdown) searchBarDropdown.style.display = "none";
      }
    }

    const mediaQuery = window.matchMedia(
      "(min-width: 992px) and (max-width: 1250px)"
    );
    handleSearchBar(mediaQuery);
    mediaQuery.addEventListener("change", () => handleSearchBar(mediaQuery));

    // Prevent clicks inside the dropdown from bubbling to the document
    if (searchBarDropdown) {
      searchBarDropdown.addEventListener("mousedown", (e) => {
        e.stopPropagation();
        // Keep focus on the input for immediate typing
        if (uniqueSearch1) setTimeout(() => uniqueSearch1.focus(), 0);
      });
      searchBarDropdown.addEventListener("click", (e) => {
        e.stopPropagation();
      });
    }

    if (uniqueSearch1) {
      uniqueSearch1.addEventListener("mousedown", (e) => {
        e.stopPropagation();
      });
      uniqueSearch1.addEventListener("click", (e) => {
        e.stopPropagation();
      });
    }

    // Close on any click outside (capture phase ensures it runs even on links before navigation)
    document.addEventListener(
      "mousedown",
      (e) => {
        const target = e.target;
        if (
          !isWithin(searchButton, target) &&
          !isWithin(searchBarDropdown, target)
        ) {
          closeDropdown();
        }
      },
      true
    );

    document.addEventListener(
      "click",
      (e) => {
        const target = e.target;
        if (
          !isWithin(searchButton, target) &&
          !isWithin(searchBarDropdown, target)
        ) {
          closeDropdown();
        }
      },
      true
    );

    // Close on Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        closeDropdown();
      }
    });
  });
</script>
