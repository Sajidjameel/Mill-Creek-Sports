<script>
    console.log($('.new-products-grid'))
    $('.new-products-grid').slick({
        infinite: false,
        arrows: true,
        speed: 500,
        slidesToShow: 5,
        slidesToScroll: 1,
        responsive: [
            {
                breakpoint: 1090,
                settings: {
                    slidesToShow: 4
                }
            },
            {
                breakpoint: 992,
                settings: {
                    slidesToShow: 2,
                }
            },
            {
                breakpoint: 570,
                settings: {
                    slidesToShow: 1,
                    centerMode: true,
                    initialSlide: 1
                }
            }
        ]
    });

    $('.featured-products-grid').slick({
        infinite: false,
        arrows: true,
        speed: 500,
        slidesToShow: 5,
        slidesToScroll: 1,
        responsive: [
            {
                breakpoint: 1090,
                settings: {
                    slidesToShow: 4
                }
            },
            {
                breakpoint: 992,
                settings: {
                    slidesToShow: 2,
                }
            },
            {
                breakpoint: 570,
                settings: {
                    slidesToShow: 1,
                    centerMode: true,
                    initialSlide: 1
                }
            }
        ]
    });

    $('.top-seller-products-grid').slick({
        infinite: false,
        arrows: true,
        speed: 500,
        slidesToShow: 5,
        slidesToScroll: 1,
        responsive: [
            {
                breakpoint: 1090,
                settings: {
                    slidesToShow: 4
                }
            },
            {
                breakpoint: 992,
                settings: {
                    slidesToShow: 2,
                }
            },
            {
                breakpoint: 570,
                settings: {
                    slidesToShow: 1,
                    centerMode: true,
                    initialSlide: 1
                }
            }
        ]
    });


    function isDesktop() {
        return window.innerWidth > 992;
    }
    function isTablet() {
        return window.innerWidth <= 992 && window.innerWidth > 768;
    }
    function isMobile() {
        return window.innerWidth <= 768 && window.innerWidth > 570;
    }
    function isMobile2() {
        return window.innerWidth < 570;
    }
    function getSlidesToShow() {
        if (isDesktop()) {
            return 5;
        }
        if (isTablet()) {
            return 2;
        }
        if (isMobile()) {
            return 2;
        }
        if (isMobile2()) {
            return 1;
        }
    }


    function syncCustomArrows(containerId) {
  console.log("Syncing arrows for:", containerId);

  let container = document.querySelector(containerId);
  if (!container) {
    console.warn("No container found:", containerId);
    return;
  }

  let slickPrev = container.querySelector('.slick-prev.slick-arrow');
  let slickNext = container.querySelector('.slick-next.slick-arrow');
  let progressBar = container.querySelector('.stp-slick-container');
  let customPrev = container.querySelector('.fp-nav-prev');
  let customNext = container.querySelector('.fp-nav-next');

  if (slickPrev?.classList.contains('slick-disabled')) {
    customPrev.style.opacity = "0.2";
  } else {
    customPrev.style.opacity = "1";
  }

  if (slickNext?.classList.contains('slick-disabled')) {
    customNext.style.opacity = "0.2";
  } else {
    customNext.style.opacity = "1";
  }

  if (!slickNext && progressBar) {
    progressBar.style.visibility = 'hidden';
  } else if (progressBar) {
    progressBar.style.display = 'flex'; 
  }
}

    document.addEventListener('DOMContentLoaded',syncCustomArrows('#New-Products-container'));

    var playersSTP, slidesSTP, displaySlidesSTP, slidesSTP, playersLengthSTP, playersSTP, percentageSTP, slidesSTP, progressBarSTP
    function setLoader(targets) {
        playersSTP = document.querySelectorAll(`${targets} .stp-product-card`);
        slidesSTP = getSlidesToShow();
        displaySlidesSTP = slidesSTP;
        playersLengthSTP = playersSTP.length
        percentageSTP = (slidesSTP * 100) / playersLengthSTP;
        
        progressBarSTP = document.querySelector(`${targets} .stp-slick-container .fp-progress-fill`)
        progressBarSTP && (progressBarSTP.style.width = `${percentageSTP}%`)
        
    }
    setLoader('#New-Products-container');
    function nextSTP(event) {

        if (slidesSTP + 1 <= playersLengthSTP) {
            percentageSTP = (((++slidesSTP) * 100) / playersLengthSTP)
            progressBarSTP.style.width = `${percentageSTP}%`
            let arrow = document.querySelector('.new-products-grid .slick-next.slick-arrow')
            arrow?.click();
            syncCustomArrows('#New-Products-container')
    }
}

    function featuredNextSTP(event) {
        if (slidesSTP + 1 <= playersLengthSTP) {
            percentageSTP = (((++slidesSTP) * 100) / playersLengthSTP)
            progressBarSTP.style.width = `${percentageSTP}%`
            document.querySelector('.featured-products-grid .slick-next.slick-arrow')?.click()
            syncCustomArrows('#Featured-Products-container');

        }
    }
    function topNextSTP(event) {
        if (slidesSTP + 1 <= playersLengthSTP) {
            percentageSTP = (((++slidesSTP) * 100) / playersLengthSTP)
            progressBarSTP.style.width = `${percentageSTP}%`
            document.querySelector('.top-seller-products-grid .slick-next.slick-arrow')?.click()
            syncCustomArrows('#Top-Products-container');
        }
    }



    function prevSTP(event) {
        if (slidesSTP - 1 >= displaySlidesSTP) {
            percentageSTP = (((--slidesSTP) * 100) / playersLengthSTP)
            progressBarSTP.style.width = `${percentageSTP}%`
            document.querySelector('.new-products-grid .slick-prev.slick-arrow')?.click();
            syncCustomArrows('#New-Products-container');
        }
    }
    function featuredPrevSTP(event) {
        if (slidesSTP - 1 >= displaySlidesSTP) {
            percentageSTP = (((--slidesSTP) * 100) / playersLengthSTP)
            progressBarSTP.style.width = `${percentageSTP}%`
            document.querySelector('.featured-products-grid .slick-prev.slick-arrow')?.click();
            syncCustomArrows('#Featured-Products-container');
        }
    }
    function topPrevSTP(event) {
        if (slidesSTP - 1 >= displaySlidesSTP) {
            percentageSTP = (((--slidesSTP) * 100) / playersLengthSTP)
            progressBarSTP.style.width = `${percentageSTP}%`
            document.querySelector('#Top-Products-container .slick-prev.slick-arrow')?.click();
            syncCustomArrows('#Top-Products-container');

        }
    }


    document.querySelectorAll('.stp-filter-badge').forEach(badge => {
        badge.addEventListener('click', function () {
            document.querySelectorAll('.stp-filter-badge').forEach(b => b.classList.remove('stp-active'));
            this.classList.add('stp-active');
        });
    });

    const topSellers = () => {
        const topSellersProducts = document.querySelectorAll('.top-sellers-products')
        const newProducts = document.querySelectorAll('.new-products')
        const featuredProducts = document.querySelectorAll('.featured-products')

        const TPslickContainer = document.querySelector('.stp-top-slick-container');
        const FPslickContainer = document.querySelector('.stp-featured-slick-container');
        const NewslickContainer = document.querySelector('.stp-new-slick-container');
        topSellersProducts.forEach((p) => p.classList.remove('d-none'));
        if (isMobile2()) {
            $('.top-seller-products-grid').slick('slickGoTo', 1, true)
        }
        else {
            $('.top-seller-products-grid').slick('slickGoTo', 0);
        }
        setLoader('#Top-Products-container')
        syncCustomArrows('#Top-Products-container')
        newProducts.forEach((e) => e.classList.add('d-none'));
        if (featuredProducts.length > 0) {
            featuredProducts.forEach((e) => e.classList.add('d-none'));
        }
        if (TPslickContainer) {
            TPslickContainer.classList.remove('d-none');
            FPslickContainer.classList.add('d-none')
            NewslickContainer.classList.add('d-none')
        }
    }
    const newProducts = () => {
        const topSellersProducts = document.querySelectorAll('.top-sellers-products')
        const newProducts = document.querySelectorAll('.new-products')
        const featuredProducts = document.querySelectorAll('.featured-products')

        const TPslickContainer = document.querySelector('.stp-top-slick-container');
        const FPslickContainer = document.querySelector('.stp-featured-slick-container');
        const NewslickContainer = document.querySelector('.stp-new-slick-container');

        topSellersProducts.forEach((p) => p.classList.add('d-none'));
        if (isMobile2()) {
            $('.new-products-grid').slick('slickGoTo', 1, true);
        } else {
            $('.new-products-grid').slick('slickGoTo', 0);
        }
        setLoader('#New-Products-container');
        syncCustomArrows('#New-Products-container')
        newProducts.forEach((e) => e.classList.remove('d-none'));
        if (featuredProducts.length > 0) {
            featuredProducts.forEach((e) => e.classList.add('d-none'));
        }
        if (NewslickContainer) {
            NewslickContainer.classList.remove('d-none')
            TPslickContainer.classList.add('d-none');
            FPslickContainer.classList.add('d-none')
        }
    }
    const featuredProducts = () => {
        const topSellersProducts = document.querySelectorAll('.top-sellers-products')
        const newProducts = document.querySelectorAll('.new-products')
        const featuredProducts = document.querySelectorAll('.featured-products')

        const TPslickContainer = document.querySelector('.stp-top-slick-container');
        const FPslickContainer = document.querySelector('.stp-featured-slick-container');
        const NewslickContainer = document.querySelector('.stp-new-slick-container');

        topSellersProducts.forEach((p) => p.classList.add('d-none'));
        if (isMobile2()) {
            $('.featured-products-grid').slick('slickGoTo', 1, true);
        } else {
            $('.featured-products-grid').slick('slickGoTo', 0);
        }
        setLoader('#Featured-Products-container');
        syncCustomArrows('#Featured-Products-container')
        newProducts.forEach((e) => e.classList.add('d-none'));
        if (featuredProducts.length > 0) {
            featuredProducts.forEach((e) => e.classList.remove('d-none'));
        }
        if (FPslickContainer) {
            FPslickContainer.classList.remove('d-none')
            TPslickContainer.classList.add('d-none');
            NewslickContainer.classList.add('d-none')
        }
    }

</script>

<script>
class ProgressBarManager {
    constructor() {
        this.isDragging = false;
        this.currentProgressBar = null;
        this.currentProgressFill = null;
        this.dragStartX = 0;
        this.initialWidth = 0;
        this.init();
    }

    init() {
        this.initializeProgressBars();
    }

    isMobileView() {
        return window.innerWidth < 570;
    }

    getPercentagePoints() {
        return this.isMobileView() ? [20, 40, 60, 80, 100] : [40, 60, 80, 100];
    }

    snapToNearestPercentage(currentPercentage) {
        const percentagePoints = this.getPercentagePoints();
        const minPercentage = percentagePoints[0];
        
        if (currentPercentage < minPercentage) {
            return minPercentage;
        }
        
        return percentagePoints.reduce((closest, point) => {
            return Math.abs(point - currentPercentage) < Math.abs(closest - currentPercentage) ? point : closest;
        });
    }

    getPercentage(progressBar, clientX) {
        const rect = progressBar.getBoundingClientRect();
        const position = clientX - rect.left;
        return Math.min(100, Math.max(0, (position / rect.width) * 100));
    }

    handleDragStart = (event, progressBar, progressFill) => {
        if (event.type === 'mousedown' && event.button !== 0) return;
        if (event.type === 'touchstart' && event.touches.length !== 1) return;
        
        const rect = progressFill.getBoundingClientRect();
        const clickX = event.type.includes('touch') ? event.touches[0].clientX : event.clientX;
        
        if (Math.abs(clickX - rect.right) <= 15) {
            this.isDragging = true;
            this.currentProgressBar = progressBar;
            this.currentProgressFill = progressFill;
            this.dragStartX = clickX;
            this.initialWidth = parseFloat(progressFill.style.width) || 0;
            progressFill.classList.add('dragging');
            
            console.log('Drag started:', this.initialWidth.toFixed(2) + '%', 'Mobile:', this.isMobileView());
            
            // Add passive listeners for move events
            document.addEventListener('mousemove', this.handleDragMove);
            document.addEventListener('touchmove', this.handleDragMove, { passive: true });
            document.addEventListener('mouseup', this.handleDragEnd);
            document.addEventListener('touchend', this.handleDragEnd);
            
            event.stopPropagation();
        }
    }

    handleDragMove = (event) => {
        if (!this.isDragging || !this.currentProgressBar) return;
        
        const clientX = event.type.includes('touch') ? event.touches[0].clientX : event.clientX;
        const rawPercentage = this.getPercentage(this.currentProgressBar, clientX);
        
        this.currentProgressFill.style.width = rawPercentage + '%';
    }

    handleDragEnd = (event) => {
        if (!this.isDragging || !this.currentProgressFill) return;
        
        let clientX;
        if (event.type.includes('touch')) {
            clientX = event.changedTouches?.[0]?.clientX || this.dragStartX;
        } else {
            clientX = event.clientX;
        }
        
        const rawPercentage = this.getPercentage(this.currentProgressBar, clientX);
        const snappedPercentage = this.snapToNearestPercentage(rawPercentage);
        
        this.currentProgressFill.style.width = snappedPercentage + '%';
        
        console.log('Drag ended - Raw:', rawPercentage.toFixed(2) + '%, Snapped:', snappedPercentage + '%, Mobile:', this.isMobileView());
        
        this.updateSlickSlider(this.currentProgressBar, snappedPercentage);
        this.endDrag();
        
        event.stopPropagation();
    }

    endDrag() {
        this.isDragging = false;
        this.currentProgressFill?.classList.remove('dragging');
        this.currentProgressBar = this.currentProgressFill = null;
        this.dragStartX = this.initialWidth = 0;
        
        document.removeEventListener('mousemove', this.handleDragMove);
        document.removeEventListener('touchmove', this.handleDragMove);
        document.removeEventListener('mouseup', this.handleDragEnd);
        document.removeEventListener('touchend', this.handleDragEnd);
    }

    handleProgressBarClick = (event, progressBar, progressFill) => {
        if (this.isDragging) return;
        const rawPercentage = this.getPercentage(progressBar, event.clientX);
        const snappedPercentage = this.snapToNearestPercentage(rawPercentage);
        
        progressFill.style.width = snappedPercentage + '%';
        console.log('Clicked - Raw:', rawPercentage.toFixed(2) + '%, Snapped:', snappedPercentage + '%, Mobile:', this.isMobileView());
        this.updateSlickSlider(progressBar, snappedPercentage);
    }

    updateSlickSlider(progressBar, percentage) {
        const container = progressBar.closest('.stp-slick-container');
        if (!container) return;
        
        const containerMap = {
            '#New-Products-container': '.new-products-grid',
            '#Featured-Products-container': '.featured-products-grid', 
            '#Top-Products-container': '.top-seller-products-grid'
        };
        
        for (const [containerId, sliderClass] of Object.entries(containerMap)) {
            if (container.querySelector(containerId) || container.closest(containerId)) {
                const slider = $(sliderClass);
                if (slider.length && typeof slider.slick === 'function') {
                    const totalSlides = slider[0].slick.slideCount;
                    const slidesToShow = getSlidesToShow();
                    const targetSlide = Math.floor((percentage / 100) * Math.max(0, totalSlides - slidesToShow));
                    
                    slider.slick('slickGoTo', Math.max(0, targetSlide), true);
                    updateProgressAfterClick(containerId, percentage);
                    break;
                }
            }
        }
    }

    initializeProgressBars() {
        document.querySelectorAll('.fp-progress-bar').forEach(progressBar => {
            if (progressBar.hasAttribute('data-progress-initialized')) return;
            progressBar.setAttribute('data-progress-initialized', 'true');
            
            const progressFill = progressBar.querySelector('.fp-progress-fill');
            if (!progressFill) return;
            
            // Use arrow functions to maintain 'this' context
            const handleClick = (e) => this.handleProgressBarClick(e, progressBar, progressFill);
            const handleMouseDown = (e) => this.handleDragStart(e, progressBar, progressFill);
            const handleTouchStart = (e) => this.handleDragStart(e, progressBar, progressFill);

            progressBar.addEventListener('click', handleClick);
            progressFill.addEventListener('mousedown', handleMouseDown, { passive: true });
            progressFill.addEventListener('touchstart', handleTouchStart, { passive: true });
        });
    }
}

// Initialize the progress bar manager
let progressBarManager;

document.addEventListener('DOMContentLoaded', function() {
    if (!progressBarManager) {
        progressBarManager = new ProgressBarManager();
    }
});

// Keep your existing functions
function updateProgressAfterClick(containerId, percentage) {
    const players = document.querySelectorAll(`${containerId} .stp-product-card`);
    if (players.length) {
        const slides = Math.floor((percentage / 100) * players.length);
        if (containerId === '#New-Products-container') {
            slidesSTP = Math.max(getSlidesToShow(), slides);
        }
        syncCustomArrows(containerId);
    }
}

function setLoader(targets) {
    const playersSTP = document.querySelectorAll(`${targets} .stp-product-card`);
    const slidesSTP = getSlidesToShow();
    const playersLengthSTP = playersSTP.length;
    
    if (playersLengthSTP === 0) return;
    
    let percentageSTP = (slidesSTP * 100) / playersLengthSTP;
    
    const isMobile = window.innerWidth < 570;
    const minPercentage = isMobile ? 20 : 40;
    percentageSTP = Math.max(minPercentage, percentageSTP);
    
    const progressBarSTP = document.querySelector(`${targets} .stp-slick-container .fp-progress-fill`);
    if (progressBarSTP) {
        progressBarSTP.style.width = `${percentageSTP}%`;
    }
}
</script>